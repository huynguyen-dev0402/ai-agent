service: nestjs-lambda
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    NODE_ENV: production
    JWT_SECRET: ${ssm:/nestjs-lambda/JWT_SECRET}
    JWT_EXPIRED: ${ssm:/nestjs-lambda/JWT_EXPIRED}
    JWT_REFRESH_SECRET: ${ssm:/nestjs-lambda/JWT_REFRESH_SECRET}
    JWT_REFRESH_EXPIRED: ${ssm:/nestjs-lambda/JWT_REFRESH_EXPIRED}
    REDIS_HOST: ${ssm:/nestjs-lambda/REDIS_HOST}
    REDIS_PORT: ${ssm:/nestjs-lambda/REDIS_PORT}
    REDIS_USERNAME: ${ssm:/nestjs-lambda/REDIS_USERNAME}
    REDIS_PASSWORD: ${ssm:/nestjs-lambda/REDIS_PASSWORD}
    DATABASE_TYPE: ${ssm:/nestjs-lambda/DATABASE_TYPE}
    DATABASE_HOST: ${ssm:/nestjs-lambda/DATABASE_HOST}
    DATABASE_USERNAME: ${ssm:/nestjs-lambda/DATABASE_USERNAME}
    DATABASE_PASSWORD: ${ssm:/nestjs-lambda/DATABASE_PASSWORD}
    DATABASE_PORT: ${ssm:/nestjs-lambda/DATABASE_PORT}
    DATABASE_NAME: ${ssm:/nestjs-lambda/DATABASE_NAME}
  vpc:
    securityGroupIds:
      - sg-xxxxxxxxxxxxxxxxx
    subnetIds:
      - subnet-xxxxxxxxxxxx
      - subnet-yyyyyyyyyyyy
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - secretsmanager:GetSecretValue
          Resource: '*'

functions:
  app:
    handler: dist/lambda.handler
    events:
      - http:
          path: /
          method: ANY
          cors: true
      - http:
          path: /{proxy+}
          method: ANY
          cors: true
    timeout: 30
    memorySize: 256

plugins:
  - serverless-plugin-typescript
  - serverless-offline

package:
  exclude:
    - node_modules/**
    - .git/**
    - test/**
    - .env
